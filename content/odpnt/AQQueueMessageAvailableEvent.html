<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html xml:lang="en-us" lang="en-us">
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <title>MessageAvailable Event</title>
      <meta property="og:site_name" content="Oracle Help Center">
      <meta property="og:title" content="Developer's Guide ">
      <meta property="og:description" content>
      <link rel="stylesheet" href="/sp_common/book-template/ohc-book-template/css/book.css">
      <link rel="shortcut icon" href="/sp_common/book-template/ohc-common/img/favicon.ico">
      <meta name="application-name" content="Developer's Guide for Microsoft Windows">
      <meta name="generator" content="DITA Open Toolkit version 1.8.5 (Mode = doc)">
      <meta name="plugin" content="SP_docbuilder HTML plugin release 18.2.2">
      <link rel="alternate" href="oracle-data-provider-net.pdf" title="PDF File" type="application/pdf">
      <meta name="robots" content="all">
      <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
      <meta name="dcterms.created" content="2018-08-24T00:49:54-07:00">
      
      <meta name="dcterms.dateCopyrighted" content="2002, 2018">
      <meta name="dcterms.category" content="database">
      <meta name="dcterms.identifier" content="E90593-02">
      
      <meta name="dcterms.product" content="en/database/oracle/oracle-database/18">
      
      <link rel="prev" href="AQQueueEvents.html" title="Previous" type="text/html">
      <link rel="next" href="OracleAQDequeueModeEnumeration.html" title="Next" type="text/html">
      <script>
        document.write('<style type="text/css">');
        document.write('body > .noscript, body > .noscript ~ * { visibility: hidden; }');
        document.write('</style>');
     </script>
      <script data-main="/sp_common/book-template/ohc-book-template/js/book-config" src="/sp_common/book-template/requirejs/require.js"></script>
      <script>
            if (window.require === undefined) {
                document.write('<script data-main="sp_common/book-template/ohc-book-template/js/book-config" src="sp_common/book-template/requirejs/require.js"><\/script>');
                document.write('<link href="sp_common/book-template/ohc-book-template/css/book.css" rel="stylesheet"/>');
            }
        </script>
      <script type="application/json" id="ssot-metadata">{"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"18","element_name":"Release 18","display_in_url":true}}}</script>
      
    <meta name="dcterms.title" content="OracleÂ® Data Provider for .NET">
    <meta name="dcterms.isVersionOf" content="ODPNT">
    <meta name="dcterms.release" content="Release 18">
  </head>
   <body>
      <div class="noscript alert alert-danger text-center" role="alert">
         <a href="AQQueueEvents.html" class="pull-left"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>Previous</a>
         <a href="OracleAQDequeueModeEnumeration.html" class="pull-right">Next<span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
         <span class="fa fa-exclamation-triangle" aria-hidden="true"></span> JavaScript must be enabled to correctly display this content
        
      </div>
      <article>
         <header>
            <ol class="breadcrumb" vocab="http://schema.org/" typeof="BreadcrumbList">
               <li property="itemListElement" typeof="ListItem"><a href="index.html" property="item" typeof="WebPage"><span property="name">Developer's Guide </span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="aq-classes.html" property="item" typeof="WebPage"><span property="name">Oracle Database Advanced Queuing Classes </span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="OracleAQQueueClass.html" property="item" typeof="WebPage"><span property="name">OracleAQQueue Class</span></a></li>
               <li property="itemListElement" typeof="ListItem"><a href="AQQueueEvents.html" property="item" typeof="WebPage"><span property="name">OracleAQQueue Events</span></a></li>
               <li class="active" property="itemListElement" typeof="ListItem">MessageAvailable Event</li>
            </ol>
            <a id="GUID-37AD57F2-4121-4C63-877A-0C06B7AA79D1" name="GUID-37AD57F2-4121-4C63-877A-0C06B7AA79D1"></a><a id="ODPNT3734"></a><a id="ODPNT3735"></a><a id="ODPNT3736"></a><a id="ODPNT3737"></a><a id="ODPNT3738"></a><a id="ODPNT3733"></a>
            
            <h2 id="ODPNT-GUID-37AD57F2-4121-4C63-877A-0C06B7AA79D1" class="sect2"><span class="enumeration_section">12.7.6.1 </span>MessageAvailable Event
            </h2>
         </header>
         <div class="ind">
            <div>
               <div class="section">
                  <p>This event is notified when a message is available in the queue for <code class="codeph">NotificationConsumers</code>.
                  </p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1">Declaration</p>
               </div>
               <!-- class="section" -->
               <div class="section"><pre class="oac_no_warn" dir="ltr">// C#
public event OracleAQMessageAvailableEventHandler MessageAvailable;
</pre></div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1">Event Data</p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p>The event handler receives an <code class="codeph">OracleAQMessageAvailableEventArgs</code> object.
                  </p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1"><span class="bold">Exceptions</span></p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p><code class="codeph">InvalidOperationException</code> - The connection is not open.
                  </p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1"><span class="bold">Remarks</span></p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p>Asynchronous notification is supported in all queue tables created with a database compatibility level of 8.1 or higher.</p>
                  <p>In order to receive the notification about message availability, the client must create an <code class="codeph">OracleAQMessageAvailableEventHandler</code> delegate to listen to this event. The delegate should be added to this event only after setting the <a href="AQQueueNotificationConsumers.html#GUID-102C6C6E-C7EE-49E2-9EE4-D32F615DA0A1">NotificationConsumers</a> and <a href="AQQueueNotification.html#GUID-54CFE8F5-3926-4E65-A939-8AE255633B89">Notification</a> properties.
                  </p>
                  <p>The notification registration takes place after the first delegate is added to the event. The notification is unregistered when the last delegate is removed from the event. Notifications set on an <code class="codeph">OracleAQQueue</code> object get cancelled automatically when the object gets disposed. 
                  </p>
                  <p>Oracle Data Provider for .NET opens a port to listen for notifications.  HA events, load balancing, and continuous query notification features also share the same port. This port can be configured centrally by setting the database notification port in an application or Web configuration file. The following example code specifies a port number of 1200:</p><pre class="oac_no_warn" dir="ltr">&lt;configuration&gt;
  &lt;oracle.dataaccess.client&gt;
    &lt;settings&gt;
      &lt;add name="DbNotificationPort" value="1200"/&gt;
    &lt;/settings&gt;
  &lt;/oracle.dataaccess.client&gt;
&lt;/configuration&gt;
</pre><p>If the configuration file does not exist or the db notification port is not specified, then ODP.NET uses a valid and random port number. The configuration file may also request for a random port number by specifying a db notification port value of -1.</p>
                  <p>The notification listener, which runs in the same application domain as ODP.NET, uses the specified port number to listen to notifications from the database. A notification listener gets created when the application registers with <code class="codeph">OracleAQQueue.MessageAvailable</code> event. One notification listener can listen to all notification types. Only one notification listener is created for each application domain.
                  </p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p class="subhead1">Example</p>
               </div>
               <!-- class="section" -->
               <div class="section">
                  <p>The following example demonstrates application notification. The first part of the example performs the requisite database setup for the database user, <code class="codeph">SCOTT</code>. The second part of the example demonstrates how an application is notified when a message is available in the queue.
                  </p><pre class="oac_no_warn" dir="ltr">-- Part I: Database setup required for this demo
 
------------------------------------------------------------------
-- SQL to grant appropriate privilege to database user, SCOTT
------------------------------------------------------------------
SQL&gt; ALTER USER SCOTT ACCOUNT UNLOCK IDENTIFIED BY Pwd4Sct;
User altered.
SQL&gt; GRANT ALL ON DBMS_AQADM TO scott;
 
------------------------------------------------------------------
-- PLSQL to create queue-table and queue and start queue for SCOTT
------------------------------------------------------------------
BEGIN
  DBMS_AQADM.CREATE_QUEUE_TABLE(
    queue_table=&gt;'scott.test_q_tab', 
    queue_payload_type=&gt;'RAW', 
    multiple_consumers=&gt;FALSE);
 
  DBMS_AQADM.CREATE_QUEUE(
    queue_name=&gt;'scott.test_q', 
    queue_table=&gt;'scott.test_q_tab');
 
  DBMS_AQADM.START_QUEUE(queue_name=&gt;'scott.test_q');
END;
/
 
------------------------------------------------------------------
-- PLSQL to stop queue and drop queue &amp; queue-table from SCOTT
------------------------------------------------------------------
BEGIN
  DBMS_AQADM.STOP_QUEUE('scott.test_q');
 
  DBMS_AQADM.DROP_QUEUE(
    queue_name =&gt; 'scott.test_q', 
    auto_commit =&gt; TRUE);
 
  DBMS_AQADM.DROP_QUEUE_TABLE(
    queue_table =&gt; 'scott.test_q_tab',
    force =&gt; FALSE, 
    auto_commit =&gt; TRUE);
END;
/
-- End of Part I, database setup.

//Part II: Demonstrates application notification
//C#
using System;
using System.Text;
using Oracle.DataAccess.Client;
using Oracle.DataAccess.Types;
 
namespace ODPSample
{
  /// &lt;summary&gt;
  /// Demonstrates how the application can be notified when a message is 
  /// available in a queue.
  /// &lt;/summary&gt;
  class Notification
  {
    static bool isNotified = false;
 
    static void Main(string[] args)
    {
      // Create connection
      string constr = "user id=scott;password=Pwd4Sct;data source=oracle";
      OracleConnection con = new OracleConnection(constr);
 
      // Create queue
      OracleAQQueue queue = new OracleAQQueue("scott.test_q", con);
 
      try
      {
        // Open connection
        con.Open();
 
        // Set message type for the queue
        queue.MessageType = OracleAQMessageType.Raw;
 
        // Add the event handler to handle the notification. The 
        // MsgReceived method will be invoked when a message is enqueued
        queue.MessageAvailable +=
          new OracleAQMessageAvailableEventHandler(Notification.MsgReceived);
 
        Console.WriteLine("Notification registered...");
 
        // Begin txn for enqueue
        OracleTransaction txn = con.BeginTransaction();
 
        Console.WriteLine("Now enqueuing message...");
 
        // Prepare message and RAW payload
        OracleAQMessage enqMsg = new OracleAQMessage();
        byte[] bytePayload = { 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 };
        enqMsg.Payload = bytePayload;
 
        // Prepare to Enqueue
        queue.EnqueueOptions.Visibility = OracleAQVisibilityMode.OnCommit;
 
        // Enqueue message
        queue.Enqueue(enqMsg);
 
        Console.WriteLine("Enqueued Message Payload      : "
          + ByteArrayToString(enqMsg.Payload as byte[]));
        Console.WriteLine("MessageId of Enqueued Message : "
          + ByteArrayToString(enqMsg.MessageId));
        Console.WriteLine();
 
        // Enqueue txn commit
        txn.Commit();
 
        // Loop while waiting for notification
        while (isNotified == false)
        {
          System.Threading.Thread.Sleep(2000);
        }
      }
      catch (Exception e)
      {
        Console.WriteLine("Error: {0}", e.Message);
      }
      finally
      {
        // Close/Dispose objects
        queue.Dispose();
        con.Close();
        con.Dispose();
      }
    }
 
    static void MsgReceived(object src, OracleAQMessageAvailableEventArgs arg)
    {
      try
      {
        Console.WriteLine("Notification Received...");
        Console.WriteLine("QueueName : {0}", arg.QueueName);
        Console.WriteLine("Notification Type : {0}", arg.NotificationType);
		
		//following type-cast to "byte[]" is required only for .NET 1.x
        byte[] notifiedMsgId = (byte[]) arg.MessageId[0];
        Console.WriteLine("MessageId of Notified Message : "
          + ByteArrayToString(notifiedMsgId));
        isNotified = true;
      }
      catch (Exception e)
      {
        Console.WriteLine("Error: {0}", e.Message);
      }
    }
	
	// Function to convert byte[] to string
    static private string ByteArrayToString(byte[] byteArray)
    {
      StringBuilder sb = new StringBuilder();
      for (int n = 0; n &lt; byteArray.Length; n++)
      {
        sb.Append((int.Parse(byteArray[n].ToString())).ToString("X"));
      }
      return sb.ToString();
    }
  }
}</pre><div class="infoboxnotealso" id="GUID-37AD57F2-4121-4C63-877A-0C06B7AA79D1__GUID-6C1EB8ED-7897-4BCD-A457-21CD8A459AEA">
                     <p class="notep1">See Also:</p>
                     <p></p>
                     <ul style="list-style-type: disc;">
                        <li>
                           <p><span class="q">"<a href="intro003.html#GUID-2A5A5F0B-E6C9-45AF-9477-FBD55F7FCDC5">Oracle.DataAccess.Client and Oracle.ManagedDataAccess.Client Namespaces</a>"</span></p>
                        </li>
                        <li>
                           <p><a href="OracleAQQueueClass.html#GUID-5C99D7AC-DDEA-446D-AF13-F3C297F7CE07">OracleAQQueue Class</a></p>
                        </li>
                        <li>
                           <p><a href="AQQueueMembers.html#GUID-54A1B6DA-2CE3-4445-83DA-F6EB878C6ACE">OracleAQQueue Members</a></p>
                        </li>
                     </ul>
                  </div>
               </div>
               <!-- class="section" -->
            </div>
         </div>
      </article>
   </body>
</html>