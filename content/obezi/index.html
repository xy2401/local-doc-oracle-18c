<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <!-- Part number: E98879-01 -->
    <!-- Published date: April 2018 -->
    <!-- See this link for directions on getting a part number: https://confluence.oraclecorp.com/confluence/display/DLPP/Archive+an+OBE -->
    <!-- Template date: 10/18/17 -->
    <title>Merging Partitions Online</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="robots" content="INDEX, FOLLOW">
    <meta name="description" content="Learn how to merge partitions online.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/obe-lite.css">
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.js"></script>
    <script src="js/jquery.tocify.jd.js"></script>
    <script src="js/leftnav.js"></script>
  
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <meta name="dcterms.created" content="2018-08-03T18:46:31+00:00">
    <meta name="dcterms.title" content="Merging partitions online">
    <meta name="dcterms.category" content="database">
    <meta name="dcterms.isVersionOf" content="OBEZI">
    <meta name="dcterms.product" content="en/database/oracle/oracle-database/18">
    <meta name="dcterms.identifier" content="E98879-01">
    <meta name="dcterms.release" content="Release 18">
  <script id="ssot-metadata" type="application/json"> {"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"18","element_name":"Release 18","display_in_url":true}}} </script>
    </head>
  <body>
    <header>
      <div class="w1024" style="min-height:55px; display:block;"> <a href="https://docs.oracle.com" class="oracle-logo"> <img src="./img/oracle_doc_logo.png" alt="Oracle Documentation" style="max-width: none;" height="22" width="236"></a> </div>
    </header>
    <!--end header-->
    <div id="content">
      <h1><img src="./img/obe_tag.png" alt="Oracle by Example branding" align="middle">Merging
        Partitions Online</h1>
      <div class="w1024" style="clear:both; position:relative; margin-top:40px;">
        <div class="navbackwide border-right"><!-- --></div>
        <div id="shownav" title="Show Navigation" tabindex="0"><span class="fa fa-list"></span></div>
        <div id="sidebar"><!-- -->
          <div class="left-nav-tut"><!-- -->
            <div id="hidenavw" title="Hide Navigation" tabindex="0"><span class="fa fa-close"></span></div>
            <div id="navbar" class="left-nav-w"><!-- -->
              <div id="toc" class="tocify"><!-- --></div>
            </div>
          </div>
        </div>
        <div id="bookContainer">
          <article>
            <section>
              <h2><img src="./img/32_begin.png" alt="section 0" class="num_circ" height="32" width="32"> Before You Begin</h2>
              <p>This 5-minute tutorial shows you how to merge partitions
                online. </p>
              <h3>Background</h3>
              <p style="margin-top: 5.38pt; margin-bottom: 0pt; text-align: left; direction: ltr; unicode-bidi: embed; vertical-align: baseline;">Before
                Oracle Database 18c, merging partitions required an exclusive
                lock on the relevant partitions for the entire duration of the
                operation.<br>
                In Oracle Database 18c, you can complete a <code> MERGE </code>
                partition maintenance operation which is often used in rolling
                up all old partitions into a single partition and then archiving
                them, online.</p>
              <h3>What Do You Need?</h3>
              <ul>
                <li>Oracle Database 18c installed</li>
                <li>A container database (CDB) and a pluggable database (PDB)</li>
                <li>The dumpfile <code> exp_sh_pdb1.dmp </code> with <code>
                    SH.SALES </code> data to import into <code> SH.SALES </code>
                  partitioned table. Download <a href="files/exp_sh_pdb1.dmp" target="_blank">
                    exp_sh_pdb1.dmp </a> to the <code> labs </code> directory
                  created on your server <code> /home/oracle/labs.</code></li>
                <li>You will use two independent console sessions in this OBE.</li>
              </ul>
            </section>
            <!-- ========================================================================================================================= -->
            <section>
              <h2 id="section_1" role="button" style="text-align: left;"><img src="./img/32_1.png" alt="section 1" class="num_circ" height="32" width="32">Merge
                Partitions Online</h2>
              <ol>
                <li>Log in to <code> PDB1 </code> PDB to create the <code> SH
                  </code> user.
                  <pre><code>sqlplus system@PDB1
Enter password: <em>password</em></code></pre>
                </li>
                <li>Create the <code> SH </code> user.
                  <pre><code>DROP USER sh CASCADE;
CREATE USER sh IDENTIFIED BY <em>password</em>;</code></pre>
                </li>
                <li>Grant the user the <code> DBA </code> role and read and
                  write privilege on the <code> DP_PDB1 </code> logical
                  directory.
                  <pre><code>GRANT dba TO sh;</code></pre>
                  <pre><code>CREATE DIRECTORY dp_pdb1 as '/home/oracle/labs';
GRANT read, write ON DIRECTORY dp_pdb1 TO sh;</code></pre>
                </li>
                <li>Create the <code> RANGE </code> partitioned table <code>
                    SH.SALES </code> from <a href="files/code1.txt" target="_blank">code1.
                    </a> </li>
                <li> Quit the session.
                  <pre><code>EXIT
</code></pre> </li>
                <li>Import rows with your dump file.<code></code>
                  <pre><code>cd /home/oracle/labs</code></pre>
                  <code></code>
                  <pre><code>$ORACLE_HOME/bin/impdp sh@PDB1 directory=dp_pdb1 dumpfile=exp_sh_pdb1.dmp remap_tablespace=USERS:SYSTEM table_exists_action=replace
Password: <em>password</em>
</code></pre>
                  <p class="note"> Ignore the error <code> GRANT SELECT ON
                      "SH"."SALES" TO "BI". </code> Ignore the five errors on <code>
                      ALTER TABLE SALES ... FOREIGN KEY. </code></p>
                </li>
                <li>Log in to <code> PDB1 </code> as <code> SYSTEM </code>
                  to create the <code> SH.I2_PROMO_ID </code> on the <code>
                    PROMO_ID </code> column.
                  <pre><code>sqlplus system@pdb1
Enter password: <em>password</em></code></pre>
                </li>
                <li>Create the <code> SH.I2_PROMO_ID </code> on the <code>
                    PROMO_ID </code> column.
                  <pre><code>DROP INDEX SH.SALES_PROMO_BIX;
DROP INDEX sh.i2_promo_id;
CREATE INDEX sh.i2_promo_id ON sh.sales (promo_id) GLOBAL;
</code></pre> </li>
                <li>Display the partitioning method of the table.
                  <pre><code>SELECT owner, table_name, partitioning_type AS type, autolist, interval
FROM   dba_part_tables WHERE  owner='SH' ; 

OWNER  TABLE_NAME      TYPE  AUTOLIST INTERVAL
------ --------------- ----- -------- -------------------------
SH     SALES           <strong>RANGE </strong>NO
</code></pre></li>
                <li>Display the partitions of the table and the high values in
                  each partition from <a href="files/code2.txt" target="_blank">code2.&nbsp;</a>
                  <pre><code>SELECT partition_name, high_value FROM dba_tab_partitions
WHERE  table_name = 'SALES' and table_owner='SH'; 
</code></pre></li>
                <li>Display the indexes on&nbsp; the table and observe which
                  indexes are partitioned.
                  <pre><code>SELECT index_name, index_type, partitioned FROM dba_indexes
WHERE  table_name='SALES';

INDEX_NAME                 INDEX_TYPE                  PAR
-------------------------- --------------------------- ---
SALES_PROD_BIX             BITMAP                      YES
SALES_CUST_BIX             BITMAP                      YES
SALES_TIME_BIX             BITMAP                      YES
SALES_CHANNEL_BIX          BITMAP                      YES
I2_PROMO_ID                NORMAL                     <strong> NO</strong>
</code></pre></li>
                <li>Display the type of partitioning of the partitioned indexes.
                  <code></code>
                  <pre><code>SELECT index_name, locality, partitioning_type AS type, autolist, interval 
FROM   dba_part_indexes WHERE owner='SH';

INDEX_NAME                 LOCALI TYPE  AUTOLIST INTERVAL
-------------------------- ------ ----- -------- -------------------------
SALES_CHANNEL_BIX          LOCAL  RANGE NO
SALES_CUST_BIX             LOCAL  RANGE NO
SALES_PROD_BIX             LOCAL  RANGE NO
SALES_TIME_BIX             LOCAL  RANGE NO
</code></pre> </li>
                <li>In another session, Session2, log in to <code> PDB1</code>
                  as <code>SH</code> to increase the quantity sold in <code>
                    SALES_Q1_2000 </code> partition.
                  <pre><code>CONNECT sh@PDB1
Enter password: <em>password</em></code></pre>
                </li>
                <li>Increase the quantity sold in <code> SALES_Q1_2000 </code>
                  partition.
                  <pre><code>UPDATE sh.sales PARTITION (sales_q1_2000) SET QUANTITY_SOLD=QUANTITY_SOLD*10; 

62197 rows updated.</code></pre>
                </li>
                <li>In Session1, merge the partition of the year 2000 to a
                  single partition. This operation can be done at the same time
                  as the DML operation.
                  <pre><code>ALTER TABLE sh.sales
        MERGE PARTITIONS sales_q1_2000,sales_q2_2000,sales_q3_2000,sales_q4_2000
        INTO PARTITION sales_2000
        COMPRESS UPDATE INDEXES <strong>ONLINE</strong>; 

</code></pre>
                  <p class="note"> The statement waits for the <code>UPDATE </code>in
                    the second session to complete.</p>
                </li>
                <li>In Session2, commit the <code>UPDATE </code>statement.<code></code>
                  <pre><code>COMMIT;</code><code>
<em></em></code></pre> </li>
                <li>In Session1, the <code>ALTER TABLE</code> statement
                  completes.<code></code>
                  <pre><code><code>ALTER TABLE sh.sales
      MERGE PARTITIONS sales_q1_2000, sales_q2_2000, sales_q3_2000, 
                       sales_q4_2000
       INTO PARTITION sales_2000
       COMPRESS UPDATE INDEXES <strong>ONLINE</strong>; 

Table altered.</code>
</code></pre></li>
                <li>Verify that the four partitions are merged into one single
                  partition. The query of step 10 reports 28 partitions. The
                  current query reports 25 partitions<span style="color: #006699;">:
                    see </span><a href="files/code3.txt" target="_blank">code3.
                  </a>
                  <pre><code>SELECT partition_name, high_value FROM dba_tab_partitions
WHERE  table_name = 'SALES' and table_owner = 'SH';<strong></strong>
<em></em></code></pre> </li>
                <li>Optionally, drop the <code> SH </code> user.
                  <pre><code>DROP USER sh CASCADE;</code></pre>
                </li>
                <li>Quit the session.
                  <pre><code>EXIT</code></pre>
                </li>
              </ol>
            </section>
          </article>
        </div>
        <code> <br class="clearfloat">
        </code></div>
    </div>
    <code>
      <!--close main-->
      <!--end content-->
      <div class="footer-container ">
        <div style="max-width: 994px; padding:10px 0 0 17px;">
          <footer class="footer-list">
            <ul>
              <li> <a href="https://www.oracle.com/corporate/index.html" target="_blank">About
                  Oracle</a> </li>
              <li> <a href="https://www.oracle.com/us/corporate/contact/index.html" target="_blank">Contact Us</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/index.html" target="_blank">Legal
                  Notices</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/terms/index.html" target="_blank">Terms
                  of Use</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/privacy/index.html" target="_blank">Your Privacy Rights</a> </li>
              <li><a href="https://www.oracle.com/pls/topic/lookup?ctx=cpyr&amp;id=en">Copyright
                  © 2017, 2018, Oracle and/or its affiliates. All rights
                  reserved.</a></li>
            </ul>
          </footer>
        </div>
        <script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_docs.js"></script>
      </div>
    </code>
  </body>
</html>
