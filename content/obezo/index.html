<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <!-- Part number: E98878-01 -->
    <!-- Published date: July 2018 -->
    <!-- See this link for directions on getting a part number: https://confluence.oraclecorp.com/confluence/display/DLPP/Archive+an+OBE -->
    <!-- Template date: 10/18/17 -->
    <title>Duplicating a CDB as an Encrypted CDB</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="robots" content="INDEX, FOLLOW">
    <meta name="description" content="Learn how to duplicate a container database (CDB) with encrypted tablespaces to be compatible on Cloud.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/obe-lite.css">
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.js"></script>
    <script src="js/jquery.tocify.jd.js"></script>
    <script src="js/leftnav.js"></script>
  
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <meta name="dcterms.created" content="2018-08-07T06:50:52+00:00">
    <meta name="dcterms.title" content="Duplicating CDBs as encrypted">
    <meta name="dcterms.category" content="database">
    <meta name="dcterms.isVersionOf" content="OBEZO">
    <meta name="dcterms.product" content="en/database/oracle/oracle-database/18">
    <meta name="dcterms.identifier" content="E98878-01">
    <meta name="dcterms.release" content="Release 18">
  <script id="ssot-metadata" type="application/json"> {"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"18","element_name":"Release 18","display_in_url":true}}} </script>
    </head>
  <body>
    <header>
      <div class="w1024" style="min-height:55px; display:block;"> <a href="https://docs.oracle.com" class="oracle-logo"> <img src="./img/oracle_doc_logo.png" alt="Oracle Documentation" style="max-width: none;" height="22" width="236"></a> </div>
    </header>
    <!--end header-->
    <div id="content">
      <h1><img src="./img/obe_tag.png" alt="Oracle by Example branding" align="middle">Duplicating
        a CDB as an Encrypted CDB</h1>
      <div class="w1024" style="clear:both; position:relative; margin-top:40px;">
        <div class="navbackwide border-right"><!-- --></div>
        <div id="shownav" title="Show Navigation" tabindex="0"><span class="fa fa-list"></span></div>
        <div id="sidebar"><!-- -->
          <div class="left-nav-tut"><!-- -->
            <div id="hidenavw" title="Hide Navigation" tabindex="0"><span class="fa fa-close"></span></div>
            <div id="navbar" class="left-nav-w"><!-- -->
              <div id="toc" class="tocify"><!-- --></div>
            </div>
          </div>
        </div>
        <div id="bookContainer"> <br>
          <article>
            <section>
              <h2><img src="./img/32_begin.png" alt="section 0" class="num_circ" height="32" width="32">Before You Begin</h2>
              <p><br>
                This 15-minute tutorial shows you how to duplicate a container
                database (CDB) with encrypted tablespaces to be compatible on
                Cloud. Duplication as encrypted or decrypted aids with the
                transition from on-premises to Cloud and conversely from Cloud
                to on-premises.<br>
                It is important to know that any user-defined tablespace in a
                Cloud CDB is encrypted. So, if you have decided to migrate an
                on-premises CDB to the Cloud, the user-defined tablespaces are
                encrypted.</p>
              <h3>Background</h3>
              <p> You are already familiar with the traditional CDB duplication
                in Oracle Database 12<em>c</em> and know how to manage keystores
                and master encryption keys in CDB root and pluggable database
                (PDBs).</p>
              <h3>What Do You Need?</h3>
              <ul>
                <li>Familiarity with CDB duplication</li>
                <li>Oracle Database 18c installed</li>
                <li>One CDB with one PDB opened: The CDB in this example has <code>
                    ORACLE_SID ORCL. </code> You can use the <a href="files/dbca.sh" target="_blank">dbca.sh </a> shell script to create <code>ORCL.
                    </code> Download the shell script to the labs directory that
                  is created on your server <code> /home/oracle/labs.</code>
                  Replace the password in the shell script with your own complex
                  password</li>
                <li>The CDB root keystore created and the transparent data
                  encryption (TDE) master key set in the CDB root and PDB</li>
              </ul>
            </section>
            <hr>
            <section>
              <h2 id="section_1" role="button" style="text-align: left;"><img src="./img/32_1.png" alt="section 1" class="num_circ" height="32" width="32">Create
                an Encrypted Tablespace in the Source CDB</h2>
              <p>In this section, you'll create an encrypted tablespace in <code>PDB1.
                  </code></p>
              <ol>
                <li>Log in to <code> ORCL </code> to check if the CDB root has
                  an open keystore. <br>
                  <pre><code>sqlplus sys@ORCL AS SYSDBA<br>Enter password: <em>password</em></code></pre>
                </li>
                <li>Check if the CDB root has an open keystore.
                  <pre><code>SELECT wrl_parameter, status, wallet_type FROM v$encryption_wallet;<br><br>WRL_PARAMETER                            STATUS  WALLET_TYPE
---------------------------------------- ------- ------------
/u01/app/oracle/admin/ORCL/wallet/       OPEN    PASSWORD
                                         CLOSED  UNKNOWN
                                         OPEN    PASSWORD</code></pre>
                </li>
                <li>Check if the TDE master encryption key is set in <code>
                    PDB1. </code> <br>
                  <pre><code>SELECT key_id, key_use, con_id FROM v$encryption_keys;<br><br>KEY_ID                         KEY_USE        CON_ID
------------------------------ ---------- ----------
AUYnUhDIz0/SvzYoC3adcvMAAAAAAA TDE IN PDB          1
AAAAAAAAAAAAAAAAAAAAAA

AazAkjtRGU+Bv5chqSRA4YEAAAAAAA TDE IN PDB          4
AAAAAAAAAAAAAAAAAAAAAA
</code></pre> </li>
                <li>Log in to <code> PDB1 </code> to create <code>TBSORCL_ENC
                  </code> as an encrypted tablespace.
                  <pre><code>CONNECT system@PDB1<br>Enter password: <em>password</em></code></pre>
                </li>
                <li>Create <code>TBSORCL_ENC </code> as an encrypted
                  tablespace.
                  <pre><code>CREATE TABLESPACE tbsorcl_enc <br>       DATAFILE '/u02/app/oracle/oradata/ORCL/pdb1/tbsenc01.dbf' SIZE 10M<br>       ENCRYPTION USING 'AES256' ENCRYPT;</code></pre>
                </li>
                <li>Create the user <code> HR. </code>
                  <pre><code>CREATE USER hr IDENTIFIED BY <em>password</em>;</code></pre>
                </li>
                <li>Grant the user <code> HR </code> appropriate privileges.
                  <pre><code>GRANT create session, create table, unlimited tablespace TO hr;</code></pre>
                </li>
                <li>Create the <code> HR.ENC </code> table in <code>TBSORCL_ENC.</code>
                  <pre><code>CREATE TABLE hr.enc (c NUMBER) TABLESPACE tbsorcl_enc;</code></pre>
                </li>
                <li>Insert rows into the <code> HR.ENC </code> table.
                  <pre><code>INSERT INTO hr.enc VALUES (1);
COMMIT;</code></pre>
                </li>
              </ol>
            </section>
            <hr>
            <section>
              <h2 id="section_2" role="button" style="text-align: left;"><img src="./img/32_2.png" alt="section 2" class="num_circ" height="32" width="32">Prepare
                the Source CDB to be Duplicated as an Encrypted CDB</h2>
              <p>In this section, you'll prepare <code>ORCL </code> to be
                duplicated as <code>CDBENC </code> (uppercase) and be
                compatible to the Cloud.</p>
              <ol>
                <li>Copy the <code> ORCL </code> parameter file for <code>
                    CDBENC. </code> First, connect to the CDB root. <br>
                  <pre><code>CONNECT / AS SYSDBA</code></pre>
                </li>
                <li>Copy the <code> ORCL </code> parameter file for <code>
                    CDBENC. </code>
                  <pre><code>CREATE PFILE FROM SPFILE;</code></pre>
                </li>
                <li> Quit the session.
                  <pre><code>EXIT</code></pre>
                </li>
                <li>Copy the <code> ORCL </code> parameter file for <code>
                    CDBENC. </code>
                  <pre><code>cp $ORACLE_HOME/dbs/initORCL.ora $ORACLE_HOME/dbs/initCDBENC.ora</code></pre>
                </li>
                <li>Read the <code> CDBENC </code> PFILE.
                  <pre><code>cat $ORACLE_HOME/dbs/initCDBENC.ora</code></pre>
                </li>
                <li>Edit the <code> CDBENC </code>parameter file from <a href="files/code1.txt" target="_blank">code1</a>.<br>
                  <ul>
                    <li>Substitute all <code> ORCL </code> entries to <code>
                        CDBENC. </code></li>
                    <li>If you migrating the on-premises CDB to Cloud, add the <code>
                        ENCRYPT_NEW_TABLESPACES </code> and set it to <code>
                        ALWAYS </code> to simulate the Cloud CDB environment.</li>
                    <li> Add the file conversion parameters. </li>
                  </ul>
                </li>
                <li>Create the TDE keystore directory for <code> CDBENC. </code>
                  <pre><code>mkdir -p /u01/app/oracle/admin/CDBENC/wallet</code></pre>
                </li>
                <li>Copy the <code> ORCL </code> keystore for <code> CDBENC </code>
                  to the directory.
                  <pre><code>cp /u01/app/oracle/admin/ORCL/wallet/ewallet.p12 /u01/app/oracle/admin/CDBENC/wallet/ewallet.p12</code>
</pre> </li>
                <li>Update the <code> $ORACLE_HOME/network/admin/sqlnet.ora </code>
                  file to set the keystore location for <code> CDBENC </code>
                  to <code> /u01/app/oracle/admin/CDBENC/wallet. </code> Read
                  the final content of <code>$ORACLE_HOME/network/admin/sqlnet.ora</code>
                  file from <a href="files/code2.txt" target="_blank">code2</a>.<br>
                </li>
                <li>Insert a net service name entry <code> CDBENC </code> for
                  <code> CDBENC </code> in <code>
                    $ORACLE_HOME/network/admin/tnsnames.ora. </code><br>
                  <pre><code><strong>CDBENC </strong>=
  (DESCRIPTION =
    (ADDRESS = (PROTOCOL = TCP)(HOST = <em>hostname</em>)(PORT = 1521))
    (CONNECT_DATA =
      (SERVER = DEDICATED)
      (SERVICE_NAME = <strong>CDBENC</strong>)
    )
  )
</code></pre></li>
                <li>Insert the following entry in <code>
                    $ORACLE_HOME/network/admin/listener.ora. </code><br>
                  <pre><code>SID_LIST_LISTENER =
   (SID_LIST=
       (SID_DESC=
            (GLOBAL_DBNAME=CDBENC)
            (ORACLE_HOME=<em>ORACLE_HOME</em>)
            (SID_NAME=CDBENC)
       )
    )
</code></pre></li>
                <li>Reload the listener.
                  <pre><code>lsnrctl reload</code></pre>
                </li>
                <li>Create the directories that are required for <code> CDBENC
                  </code> instance to start.
                  <pre><code>mkdir -p /u01/app/oracle/admin/CDBENC/adump<br>mkdir -p /u03/app/oracle/fast_recovery_area/CDBENC</code></pre>
                </li>
                <li>Create the password file for <code> CDBENC </code> with
                  the same password as for <code> ORCL. </code>
                  <pre><code>orapwd file=$ORACLE_HOME/dbs/orapwCDBENC password=<em>password </em>entries=5</code></pre>
                </li>
                <li>Set the <code> ORACLE_SID </code> environment variable to
                  <code> CDBENC </code> to start a connection into <code>
                    CDBENC. </code>
                  <pre><code>export ORACLE_SID=CDBENC<br>sqlplus / AS SYSDBA            </code></pre>
                </li>
                <li>Create the server parameter file from the parameter file for
                  <code> CDBENC. </code>
                  <pre><code>CREATE SPFILE FROM PFILE;               </code></pre>
                </li>
                <li>Start the <code> CDBENC </code> instance.<br>
                  <pre>STARTUP NOMOUNT<code>             </code></pre>
                </li>
                <li>Open the <code> CDBENC </code> wallet.
                  <pre>ADMINISTER KEY MANAGEMENT SET KEYSTORE OPEN IDENTIFIED BY <em>password </em><br>           CONTAINER = ALL;<code></code></pre>
                </li>
                <li>Check if the <code> CDBENC </code> wallet is open.
                  <pre><code>SELECT wrl_parameter, status, wallet_type FROM v$encryption_wallet;<br><br>WRL_PARAMETER                            STATUS  WALLET_TYPE
---------------------------------------- ------- ------------
/u01/app/oracle/admin/CDBENC/wallet/     OPEN    PASSWORD
</code></pre> </li>
                <li>Quit the session.
                  <pre><code>EXIT</code></pre>
                </li>
              </ol>
            </section>
            <hr>
            <section>
              <h2 id="section_3" role="button" style="text-align: left;"><img src="./img/32_3.png" alt="section 3" class="num_circ" height="32" width="32">Duplicate
                the Source CDB to a New Encrypted CDB</h2>
              <p>In this section, you'll duplicate the <code> ORCL </code> CDB
                that contains encrypted tablespaces to <code> CDBENC. </code></p>
              <ol>
                <li>Launch <code> rman </code> to create a connection to the
                  auxiliary CDB instance that will be the new duplicated <code>
                    CDBENC </code> CDB and to the source (RMAN target) <code>
                    ORCL </code> that will be duplicated.
                  <pre><code>rman AUXILIARY sys TARGET sys@ORCL

target database Password: <em>password</em>
connected to target database: ORCL (DBID=1490974532)
auxiliary database Password: <em>password</em>
connected to auxiliary database: CDBENC (not mounted)
</code></pre> </li>
                <li>Before you start the duplication process, set the decryption
                  on.
                  <pre><code>SET DECRYPTION WALLET OPEN IDENTIFIED BY <em>password</em>;</code></pre>
                  During the duplicate operation, if the auxiliary instance is
                  using a keystore that is not an auto-login keystore, you need
                  to supply the password for the keystore by using the <code>
                    SET DECRYPTION </code> command. This is because the backups
                  are encrypted by using the keystore on the source CDB and
                  those backups need to be decrypted in order for the resource
                  to work. Similarly, the media recovery needs to apply redo,
                  which could also be encrypted. For these operations to
                  succeed, the auxiliary keystore needs to be opened during the
                  duplicate process. By supplying the password of the keystore
                  in the duplicate command, the duplicate command opens the
                  keystore automatically after the auxiliary is bounced during
                  the duplicate process.</li>
                <li>Start the duplication process.
                  <pre><code>DUPLICATE TARGET DATABASE TO cdbenc <br>          FROM ACTIVE DATABASE
          DB_FILE_NAME_CONVERT ('ORCL', 'CDBENC');</code></pre>
                </li>
                <li>See the progress of the duplication operation from <a href="files/code3.txt" target="_blank">code3</a>.<br>
                </li>
                <li>Exit <code> rman. </code>
                  <pre><code>EXIT</code></pre>
                </li>
                <li>Launch a SQL*Plus session.<br>
                  <pre><code>sqlplus sys@CDBENC AS SYSDBA<br>Enter password: <em>password</em><br></code></pre>
                </li>
                <li>View the PDB that is created.<br>
                  <pre><code>SHOW PDBS<br>
    CON_ID CON_NAME                       OPEN MODE  RESTRICTED
---------- ------------------------------ ---------- ----------
         2 PDB$SEED                       READ ONLY  NO
         4 <strong>PDB1                           </strong>READ WRITE NO<br></code></pre>
                </li>
                <li>Set your session to <code> PDB1</code><code>. </code><br>
                  <pre><code>ALTER SESSION SET CONTAINER=PDB1;</code></pre>
                </li>
                <li>Check in <code> PDB1 </code> of <code> CDBENC </code>
                  that the <code> TBSORCL_ENC </code> tablespace is encrypted.<br>
                  <pre><code>SELECT tablespace_name, encrypted FROM dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO
UNDOTBS1                       NO
TEMP                           NO
<strong>TBSORCL_ENC                    YES</strong></code></pre>
                </li>
                <li>Open the keystore in the PDB.
                  <pre><code>ADMINISTER KEY MANAGEMENT SET KEYSTORE OPEN IDENTIFIED BY <em>password</em>;          </code></pre>
                </li>
                <li>Create a new tablespace without the <code> ENCRYPTION
                    ENCRYPT </code> clauses.
                  <pre><code>CREATE TABLESPACE new_tbs_enc
       DATAFILE '/u02/app/oracle/oradata/CDBENC/pdb1/newenc01.dbf' SIZE 10M;</code></pre>
                </li>
                <li>Verify that the new tablespace is encrypted.
                  <pre><code>SELECT tablespace_name, encrypted FROM dba_tablespaces;

TABLESPACE_NAME                ENC
------------------------------ ---
SYSTEM                         NO
SYSAUX                         NO</code>
UNDOTBS1                       NO
TEMP                           NO
<strong>TBSORCL_ENC                    YES<br>NEW_TBS_ENC                    YES<br></strong></pre>
                </li>
              </ol>
            </section>
          </article>
          <code> </code></div>
        <code> <br class="clearfloat">
        </code></div>
      <code> </code></div>
    <code>
      <!--close main-->
      <!--end content-->
      <div class="footer-container ">
        <div style="max-width: 994px; padding:10px 0 0 17px;">
          <footer class="footer-list">
            <ul>
              <li> <a href="https://www.oracle.com/corporate/index.html" target="_blank">About
                  Oracle</a> </li>
              <li> <a href="https://www.oracle.com/us/corporate/contact/index.html" target="_blank">Contact Us</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/index.html" target="_blank">Legal
                  Notices</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/terms/index.html" target="_blank">Terms
                  of Use</a> </li>
              <li> <a href="https://www.oracle.com/us/legal/privacy/index.html" target="_blank">Your Privacy Rights</a> </li>
              <li><a href="https://www.oracle.com/pls/topic/lookup?ctx=cpyr&amp;id=en">Copyright
                  © 2018 Oracle and/or its affiliates. All rights reserved.</a></li>
            </ul>
          </footer>
        </div>
        <script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_docs.js"></script>
      </div>
    </code>
  </body>
</html>
