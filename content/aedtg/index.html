<!DOCTYPE html>
<html lang="en">
  <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type">
    <!-- Part number: E93295-01 -->
    <!-- Published date: June 2018 -->
    <!-- See this link for directions on getting a part number: https://confluence.oraclecorp.com/confluence/display/DLPP/Archive+an+OBE -->
    <!-- Template date: 10/18/17 -->
    <title>Using Dynamic Container Maps</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="robots" content="INDEX, FOLLOW">
    <meta name="description" content="Learn how to use container maps.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/font-awesome.min.css">
    <link rel="stylesheet" href="css/obe-lite.css">
    <script src="js/jquery-1.11.0.min.js"></script>
    <script src="js/jquery-ui-1.10.4.custom.js"></script>
    <script src="js/jquery.tocify.jd.js"></script>
    <script src="js/leftnav.js"></script>
  
    <link rel="schema.dcterms" href="http://purl.org/dc/terms/">
    <meta name="dcterms.created" content="2018-08-03T18:46:28+00:00">
    <meta name="dcterms.title" content="Using dynamic container map">
    <meta name="dcterms.category" content="database">
    <meta name="dcterms.isVersionOf" content="AEDTG">
    <meta name="dcterms.product" content="en/database/oracle/oracle-database/18">
    <meta name="dcterms.identifier" content="E93295-01">
    <meta name="dcterms.release" content="Release 18">
  <script id="ssot-metadata" type="application/json"> {"primary":{"category":{"short_name":"database","element_name":"Database","display_in_url":true},"suite":{"short_name":"oracle","element_name":"Oracle","display_in_url":true},"product_group":{"short_name":"not-applicable","element_name":"Not applicable","display_in_url":false},"product":{"short_name":"oracle-database","element_name":"Oracle Database","display_in_url":true},"release":{"short_name":"18","element_name":"Release 18","display_in_url":true}}} </script>
    </head>
  <body>
    <header>
      <div class="w1024" style="min-height:55px; display:block;"> <a href="https://docs.oracle.com" class="oracle-logo"> <img src="./img/oracle_doc_logo.png" alt="Oracle Documentation" style="max-width: none;" height="22" width="236"></a> </div>
    </header>
    <!--end header-->
    <div id="content">
      <h1><img src="./img/obe_tag.png" alt="Oracle by Example branding" align="middle">
        Using Dynamic Container Maps</h1>
      <div class="w1024" style="clear:both; position:relative; margin-top:40px;">
        <div class="navbackwide border-right"><!-- --></div>
        <div id="shownav" title="Show Navigation" tabindex="0"><span class="fa fa-list"></span></div>
        <div id="sidebar"><!-- -->
          <div class="left-nav-tut"><!-- -->
            <div id="hidenavw" title="Hide Navigation" tabindex="0"><span class="fa fa-close"></span></div>
            <div id="navbar" class="left-nav-w"><!-- -->
              <div id="toc" class="tocify"><!-- --></div>
            </div>
          </div>
        </div>
        <div id="bookContainer">
          <article>
            <section>
              <h2><img src="./img/32_begin.png" alt="section 0" class="num_circ" height="32" width="32">Before You Begin</h2>
              <p>This 15-minute tutorial shows you how to use container maps.</p>
              <h3>Background</h3>
              <p> A container map in Oracle Database 12c enables a session
                connected to an application root to issue SQL statements that
                are routed to the appropriate pluggable database (PDB),
                depending on the value of a predicate used in the SQL statement.
                Container maps enable the partitioning of data at the
                application PDB level when you don't physically partition the
                data at the table level. </p>
              <p>When you create or drop new PDBs, you can dynamically update
                container maps.</p>
              <h3>What Do You Need?</h3>
              <ul>
                <li>Familiarity with Oracle Database 12c container maps</li>
                <li>Oracle Database 18c installed</li>
                <li>A container database (CDB)<code></code></li>
                <li>The <a href="files/container_map.sh" target="_blank">container_map.sh,
                    </a> <a href="files/create_pdb1.sql" target="_blank">create_pdb1.sql,
                    </a> and <a href="files/create_container_map.sql" target="_blank">create_container_map.sql
                    </a>scripts downloaded on your server to the <code>
                    /home/oracle/labs </code> labs directory with passwords
                  updated</li>
              </ul>
            </section>
            <hr>
            <section>
              <h2 id="section_1" role="button" style="text-align: left;"><img src="./img/32_1.png" alt="section 1" class="num_circ" height="32" width="32">Configure
                a Container Map in the Application Root</h2>
              <ol>
                <li>Execute the <code> /home/oracle/labs/container_map.sh </code>
                  shell script.
                  <pre><code>/home/oracle/labs/container_map.sh</code></pre>
                </li>
                <li>Log in to <code> HR_ROOT </code> as <code> SYS. </code>
                  <pre><code>sqlplus sys@HR_ROOT AS SYSDBA
Enter password: <em>password</em></code></pre>
                </li>
                <li>Verify the data stored in the<code></code> <code>
                    SCOTT.DEPT </code> table.
                  <pre><code>SELECT deptno, dname, loc FROM scott.dept;

    DEPTNO DNAME          LOC
---------- -------------- -------------
        10 ACCOUNTING     NEW YORK
        20 RESEARCH       DALLAS
        30 SALES          CHICAGO</code></pre>
                </li>
                <li> Look at the data in the <code> SCOTT.EMP </code> table
                  and compare it to <a href="files/code1.txt" target="_blank">code1</a>.
                  <pre><code>SELECT empno, ename, deptno FROM scott.emp;
</code></pre> </li>
                <li>Find the application PDBs associated with <code>HR_ROOT. </code>
                  Displayed <code> CON_ID </code> values may be different.
                  <pre><code>SHOW PDBS

    CON_ID CON_NAME                      OPEN MODE  RESTRICTED
---------- ----------------------------- ---------- ----------
         6 HR_ROOT                       READ WRITE NO
         7 SALES                         READ WRITE NO
         8 ACCOUNTING                    READ WRITE NO
        12 RESEARCH                      READ WRITE NO</code></pre>
                </li>
                <li>Find the container map table name.
                  <pre><code>SELECT owner, table_name FROM dba_tables WHERE container_map_object='YES';
 
OWNER          TABLE_NAME
-------------- ---------------------
SCOTT          MAPTABLE
</code></pre> </li>
                <li>Compare the description of the container map table to <a href="files/code2.txt" target="_blank">code2</a>.
                  <pre><code>SET LONG 20000
SELECT dbms_metadata.get_ddl('TABLE','MAPTABLE','SCOTT') FROM dual;
</code></pre> </li>
                <li>Verify that the query for department 20 is routed to the
                  appropriate PDB.
                  <pre><code>SET LINESIZE 180
SELECT deptno, dname, loc FROM scott.dept WHERE deptno = 20;
 
    DEPTNO DNAME          LOC
---------- -------------- -------------
        20 RESEARCH       DALLAS</code></pre>
                </li>
                <li>Compare the execution plan to <a href="files/code3.txt" target="_blank">code3</a>.
                  Observe the partition number in the Pstart and Pstop columns.
                  <br>
                  <pre><code>SELECT * FROM dbms_xplan.display_cursor();</code></pre>
                </li>
              </ol>
            </section>
            <hr>
            <section>
              <h2 id="section_2" role="button" style="text-align: left;"><img src="./img/32_2.png" alt="section 2" class="num_circ" height="32" width="32">Create
                Application PDBs</h2>
              <ol>
                <li>Create the <code> DEVT </code> PDB for departments 60, 70,
                  80, 90, and 100, and declare the automatic update of&nbsp;
                  associated container map table.
                  <pre><code>CREATE PLUGGABLE DATABASE devt 
     ADMIN USER admin IDENTIFIED BY <em>password</em>
     CREATE_FILE_DEST='/u02/app/oracle/oradata/ORCL/hr_root/devt'
     CONTAINER_MAP UPDATE (ADD PARTITION devt VALUES (60, 70, 80, 90, 100)); 
</code></pre> </li>
                <li>Open <code> DEVT. </code>
                  <pre><code>ALTER PLUGGABLE DATABASE devt OPEN;</code></pre>
                </li>
                <li>Log in to the <code> DEVT </code> application PDB as <code>
                    SYS. </code>
                  <pre><code>CONNECT sys@devt AS SYSDBA
Enter password: <em>password</em></code></pre>
                </li>
                <li>Synchronize the application.
                  <pre><code>ALTER PLUGGABLE DATABASE APPLICATION hr_app SYNC;</code></pre>
                </li>
                <li>Add rows to the <code> SCOTT.DEPT </code> table.
                  <pre><code>INSERT INTO scott.DEPT VALUES (60,'DEVT','FRANCE');
INSERT INTO scott.DEPT VALUES (70,'DEVT','GERMANY');</code></pre>
                  <pre><code>INSERT INTO scott.DEPT VALUES (40,'Admin','Poland');
INSERT INTO scott.DEPT VALUES (40,'Admin','Poland')
                  *
ERROR at line 1:
ORA-65391: violation of container map partitions</code>
<em></em></pre>
                  <p class="note"> You can't add department 40 to <code>
                      SCOTT.DEPT </code> table because the value doesn't refer
                    to any PDB whose value is defined in the partitions of the <code>
                      SCOTT.MAPTABLE LIST </code> partitioned map table. </p>
                </li>
                <li>Add rows to the <code> SCOTT.EMP </code> table.
                  <pre><code>INSERT INTO scott.EMP VALUES (7499,'ALLEN','Dev',7698,TO_date('20-2-1981','dd-mm-yyyy'),1600,300,60);
INSERT INTO scott.EMP VALUES (7521,'WARD','Dev',7698,TO_date('22-2-1981','dd-mm-yyyy'),1250,500,70);
</code></pre>
                  <pre><code>COMMIT;</code></pre>
                </li>
                <li>Connect to <code> HR_ROOT.</code>
                  <pre><code>CONNECT sys@HR_ROOT AS SYSDBA
Enter password: <em>password</em></code></pre>
                </li>
                <li>Verify that departments 60 and 70 correspond to values
                  defined in the partitions of the <code> SCOTT.MAPTABLE LIST </code>
                  partitioned map table.
                  <pre><code>SELECT partition_name, high_value FROM dba_tab_partitions
WHERE  table_name='MAPTABLE' ORDER BY 1;
   
PARTITION_NAME HIGH_VALUE
-------------- ------------------------------
ACCOUNTING     10
DEVT           60, 70, 80, 90, 100
RESEARCH       20
SALES          30</code></pre>
                  <p class="note"> Creation of the <code> DEVT </code>
                    application PDB for departments 60, 70, 80, 90, and 100
                    automatically defined a new partition in the <code>
                      SCOTT.MAPTABLE LIST </code> partitioned map table.</p>
                </li>
                <li>Keep departments 60 and 70 in the <code> DEVT </code> PDB
                  and move the rest of the values defined in <code> DEVT </code>
                  to the <code> ADMINISTRATION </code> application PDB.
                  Declare the automatic update of the associated container map
                  table.
                  <pre><code>CREATE PLUGGABLE DATABASE administration 
ADMIN USER admin IDENTIFIED BY <em>password</em>
   CREATE_FILE_DEST = '/u02/app/oracle/oradata/ORCL/hr_root/administration'
   CONTAINER_MAP UPDATE (SPLIT PARTITION devt INTO  
( PARTITION devt values (60, 70), 
                                PARTITION administration));</code></pre>
                </li>
                <li>Open the <code>ADMINISTRATION </code> application PDB.
                  <pre><code>ALTER PLUGGABLE DATABASE administration OPEN;</code></pre>
                </li>
                <li>Log in to the <code> ADMINISTRATION </code> application
                  PDB as <code> SYS. </code>
                  <pre><code>CONNECT sys@ADMINISTRATION AS SYSDBA
Enter password: <em>password</em></code></pre>
                </li>
                <li>Synchronize the application.
                  <pre><code>ALTER PLUGGABLE DATABASE APPLICATION hr_app SYNC;</code></pre>
                </li>
                <li>Connect to <code> HR_ROOT</code><code>. </code>
                  <pre><code>CONNECT sys@HR_ROOT AS SYSDBA
Enter password: <em>password</em></code></pre>
                </li>
                <li>Verify that departments 60 and 70 correspond to values
                  defined for the <code> DEVT </code> PDB, that departments
                  80, 90, and 100 correspond to values defined for <code>
                    ADMINISTRATION </code> PDB, and that a new partition is
                  created in the <code> SCOTT.MAPTABLE LIST </code>
                  partitioned map table.
                  <pre><code>SELECT partition_name, high_value FROM dba_tab_partitions
WHERE  table_name='MAPTABLE' ORDER BY 1;

PARTITION_NAME HIGH_VALUE
-------------- ------------------------------
ACCOUNTING     10
ADMINISTRATION 80, 90, 100
DEVT           60, 70
RESEARCH       20
SALES          30</code></pre>
                </li>
                <li>Quit the session.
                  <pre><code>EXIT</code>            </pre>
                </li>
              </ol>
            </section>
          </article>
        </div>
        <br class="clearfloat">
      </div>
    </div>
    <!--close main-->
    <!--end content-->
    <div class="footer-container ">
      <div style="max-width: 994px; padding:10px 0 0 17px;">
        <footer class="footer-list">
          <ul>
            <li> <a href="https://www.oracle.com/corporate/index.html" target="_blank">About
                Oracle</a> </li>
            <li> <a href="https://www.oracle.com/us/corporate/contact/index.html" target="_blank">Contact Us</a> </li>
            <li> <a href="https://www.oracle.com/us/legal/index.html" target="_blank">Legal
                Notices</a> </li>
            <li> <a href="https://www.oracle.com/us/legal/terms/index.html" target="_blank">Terms
                of Use</a> </li>
            <li> <a href="https://www.oracle.com/us/legal/privacy/index.html" target="_blank">Your
                Privacy Rights</a> </li>
            <li><a href="https://www.oracle.com/pls/topic/lookup?ctx=cpyr&amp;id=en">Copyright
                Â© 2018, Oracle and/or its affiliates. All rights reserved.</a></li>
          </ul>
        </footer>
      </div>
      <script type="text/javascript" src="https://www.oracleimg.com/us/assets/metrics/ora_docs.js"></script>
    </div>
  </body>
</html>
